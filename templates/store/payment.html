{% extends 'base.html' %}
{% block title %}Paiement{% endblock %}

{% block extra_css %}
<style>
    .payment-form .form-control {
        font-size: 1rem;
        padding: 0.75rem;
        margin-bottom: 1rem;
        height: 48px;
    }
    .payment-form .btn {
        font-size: 1rem;
        padding: 0.75rem;
        height: 48px;
        touch-action: manipulation;
    }
    #card-element {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 1rem;
        height: 48px;
    }
    .error-message {
        color: var(--danger);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: none;
    }
    @media (max-width: 767px) {
        .payment-form .form-control,
        #card-element,
        .payment-form .btn {
            font-size: 0.9rem;
            padding: 0.5rem;
            height: 44px;
        }
        .payment-form {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4 text-center">Paiement</h2>
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h4 class="mb-3">Récapitulatif de la commande</h4>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cart_items %}
                                <tr>
                                    <td>{{ item.product.name }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.product.price|floatformat:2 }} €</td>
                                    <td>{{ item.subtotal|floatformat:2 }} €</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"><strong>Total</strong></td>
                                <td><strong>{{ total|floatformat:2 }} €</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <h4 class="mb-3 mt-4">Informations de paiement</h4>
                    <form id="payment-form" class="payment-form" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="cardholder-name" class="form-label">Nom sur la carte</label>
                            <input type="text" id="cardholder-name" class="form-control" placeholder="John Doe" required>
                        </div>
                        <div class="mb-3">
                            <label for="card-element" class="form-label">Informations de carte</label>
                            <div id="card-element"></div>
                            <div id="card-errors" class="error-message"></div>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Payer {{ total|floatformat:2 }} €</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_key }}');
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#32325d',
                '::placeholder': { color: '#aab7c4' },
                lineHeight: '44px'
            }
        }
    });
    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');
    const cardErrors = document.getElementById('card-errors');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        cardErrors.style.display = 'none';

        const { paymentMethod, error } = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
            billing_details: {
                name: document.getElementById('cardholder-name').value
            }
        });

        if (error) {
            cardErrors.textContent = error.message;
            cardErrors.style.display = 'block';
        } else {
            const response = await fetch('{% url "store:process_payment" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ payment_method_id: paymentMethod.id })
            });
            const result = await response.json();
            if (result.success) {
                window.location.href = '{% url "store:payment_success" %}';
            } else {
                cardErrors.textContent = result.error;
                cardErrors.style.display = 'block';
            }
        }
    });
</script>
{% endblock %}